{"version":3,"sources":["meteor://ðŸ’»app/packages/johanbrook:publication-collector/publication-collector.js"],"names":["module","export","PublicationCollector","Meteor","link","v","Match","check","Mongo","MongoID","EventEmitter","validMongoId","OneOf","String","ObjectID","constructor","opts","userId","Optional","delayInMs","Integer","_documents","unblock","_idFilter","idStringify","idParse","_isDeactivated","collect","name","args","callback","_","isFunction","length","pop","handler","server","publish_handlers","Error","Promise","resolve","reject","done","res","completeCollecting","collections","stop","once","setTimeout","_generateResponse","result","call","_publishHandlerResult","cursors","_isCursor","push","Array","isArray","areCursors","reduce","valid","cur","error","collectionNames","i","collectionName","_getCollectionName","hasOwnProperty","forEach","_ensureCollectionInRes","_publishCursor","e","ready","added","collection","id","fields","addedDocument","extend","_id","omit","changed","existingDocument","fieldsNoId","value","key","undefined","removed","isEmpty","emit","onStop","c","output","documents","values"],"mappings":"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","file":"/packages/johanbrook_publication-collector.js","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\nimport { Mongo } from 'meteor/mongo';\nimport { MongoID } from 'meteor/mongo-id';\nimport { EventEmitter } from 'events';\n\nconst validMongoId = Match.OneOf(String, Mongo.ObjectID);\n\n/*\n  This class describes something like Subscription in\n  meteor/meteor/packages/ddp/livedata_server.js, but instead of sending\n  over a socket it just collects data.\n*/\nexport class PublicationCollector extends EventEmitter {\n\n  constructor(opts = {}) {\n    super();\n    check(opts.userId, Match.Optional(String));\n    check(opts.delayInMs, Match.Optional(Match.Integer));\n\n    // Object where the keys are collection names, and then the keys are _ids\n    this._documents = {};\n    this.unblock = () => {};\n    this.userId = opts.userId;\n    this._idFilter = {\n      idStringify: MongoID.idStringify,\n      idParse: MongoID.idParse\n    };\n    this._isDeactivated = () => {};\n\n    this.delayInMs = opts.delayInMs;\n  }\n\n  collect(name, ...args) {\n    let callback;\n    // extracts optional callback from latest argument\n    if (_.isFunction(args[args.length - 1])) {\n      callback = args.pop();\n    }\n\n    const handler = Meteor.server.publish_handlers[name];\n\n    if (!handler) {\n      throw new Error(`PublicationCollector: Couldn't find publication \"${name}\"! Did you misspell it?`);\n    }\n\n    return new Promise((resolve, reject) => {\n\n      const done = (...res) => {\n        callback && callback(...res);\n        resolve(...res);\n      };\n\n      const completeCollecting = (collections) => {\n        try {\n          done(collections);\n        } finally {\n          // stop the subscription\n          this.stop();\n        }\n      };\n\n      // adds a one time listener function for the \"ready\" event\n      this.once('ready', (collections) => {\n        if (this.delayInMs) {\n          Meteor.setTimeout(() => {\n            // collections is out of date, so we need to regenerate\n            collections = this._generateResponse();\n            completeCollecting(collections);\n          }, this.delayInMs);\n        } else {\n          // immediately complete\n          completeCollecting(collections);\n        }\n      });\n\n      const result = handler.call(this, ...args);\n\n      this._publishHandlerResult(result);\n    });\n  }\n\n  /**\n   * Reproduces \"_publishHandlerResult\" processing\n   * @see {@link https://github.com/meteor/meteor/blob/master/packages/ddp-server/livedata_server.js#L1045}\n   */\n  _publishHandlerResult(res) {\n    const cursors = [];\n\n    // publication handlers can return a collection cursor, an array of cursors or nothing.\n    if (this._isCursor(res)) {\n      cursors.push(res);\n    } else if (Array.isArray(res)) {\n      // check all the elements are cursors\n      const areCursors = res.reduce((valid, cur) => valid && this._isCursor(cur), true);\n      if (!areCursors) {\n        this.error(new Error('PublicationCollector: Publish function returned an array of non-Cursors'));\n        return;\n      }\n      // find duplicate collection names\n      const collectionNames = {};\n      for (let i = 0; i < res.length; ++i) {\n        const collectionName = res[i]._getCollectionName();\n        if ({}.hasOwnProperty.call(collectionNames, collectionName)) {\n          this.error(new Error(\n            `PublicationCollector: Publish function returned multiple cursors for collection ${collectionName}`\n          ));\n          return;\n        }\n        collectionNames[collectionName] = true;\n        cursors.push(res[i]);\n      }\n    } else if (res) {\n      // truthy values other than cursors or arrays are probably a\n      // user mistake (possible returning a Mongo document via, say,\n      // `coll.findOne()`).\n      this.error(new Error('PublicationCollector: Publish function can only return a Cursor or an array of Cursors'));\n    }\n\n    if (cursors.length > 0) {\n      try {\n        // for each cursor we call _publishCursor method which starts observing the cursor and\n        // publishes the results.\n        cursors.forEach((cur) => {\n          this._ensureCollectionInRes(cur._getCollectionName());\n          cur._publishCursor(this);\n        });\n      } catch (e) {\n        this.error(e);\n        return;\n      }\n\n      // mark subscription as ready (_publishCursor does NOT call ready())\n      this.ready();\n    }\n  }\n\n  added(collection, id, fields) {\n    check(collection, String);\n    check(id, validMongoId);\n\n    this._ensureCollectionInRes(collection);\n\n    // Make sure to ignore the _id in fields\n    const addedDocument = _.extend({_id: id}, _.omit(fields, '_id'));\n    this._documents[collection][id] = addedDocument;\n  }\n\n  changed(collection, id, fields) {\n    check(collection, String);\n    check(id, validMongoId);\n\n    this._ensureCollectionInRes(collection);\n\n    const existingDocument = this._documents[collection][id];\n    const fieldsNoId = _.omit(fields, '_id');\n\n    if (existingDocument) {\n      _.extend(existingDocument, fieldsNoId);\n\n      // Delete all keys that were undefined in fields (except _id)\n      _.forEach(fields, (value, key) => {\n        if (value === undefined) {\n          delete existingDocument[key];\n        }\n      });\n    }\n  }\n\n  removed(collection, id) {\n    check(collection, String);\n    check(id, validMongoId);\n\n    this._ensureCollectionInRes(collection);\n\n    delete this._documents[collection][id];\n\n    if (_.isEmpty(this._documents[collection])) {\n      delete this._documents[collection];\n    }\n  }\n\n  ready() {\n    // Synchronously calls each of the listeners registered for the \"ready\" event\n    this.emit('ready', this._generateResponse());\n  }\n\n  onStop(callback) {\n    // Adds a one time listener function for the \"stop\" event\n    this.once('stop', callback);\n  }\n\n  stop() {\n    // Synchronously calls each of the listeners registered for the \"stop\" event\n    this.emit('stop');\n  }\n\n  error(error) {\n    throw error;\n  }\n\n  _isCursor(c) {\n    return c && c._publishCursor;\n  }\n\n  _ensureCollectionInRes(collection) {\n    this._documents[collection] = this._documents[collection] || {};\n  }\n\n  _generateResponse() {\n    const output = {};\n\n    _.forEach(this._documents, (documents, collectionName) => {\n      output[collectionName] = _.values(documents);\n    });\n\n    return output;\n  }\n}\n"]}